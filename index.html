<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Street Survey Collector</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    
    <!-- Camera View (Main) -->
    <div id="camera-view" class="view active">
      
      <!-- Camera Preview -->
      <video id="camera-preview" autoplay playsinline muted></video>
      
      <!-- Top Status Bar -->
      <div id="top-bar">
        <div class="status-group gps-group">
          <span class="status-icon">üìç</span>
          <span id="gps-coords">---, ---</span>
          <span id="gps-accuracy" class="accuracy-badge">---</span>
        </div>
        
        <div id="recording-indicator">
          <span class="rec-dot"></span>
          <span id="rec-time">00:00:00</span>
        </div>
        
        <div class="status-group accel-group">
          <span class="status-icon">üìê</span>
          <span id="accel-values">--</span>
        </div>
      </div>
      
      <!-- Capacity Bar -->
      <div id="capacity-bar">
        <div id="capacity-fill"></div>
        <div class="capacity-text">
          <span id="capacity-used">0 MB</span>
          <span>/</span>
          <span id="capacity-limit">1000 MB</span>
        </div>
        <span id="capacity-time"></span>
      </div>
      
      <!-- Warning Banner -->
      <div id="warning-banner" style="display: none;">
        <span id="warning-text"></span>
        <button id="warning-dismiss">‚úï</button>
      </div>
      
      <!-- Mini Map -->
      <div id="mini-map-container" style="display: none;">
        <div id="mini-map"></div>
      </div>
      
      <!-- Capture Counter -->
      <div id="capture-counter">
        <span class="counter-icon">üì∑</span>
        <span id="counter-value">0</span>
      </div>
      
      <!-- Bottom Controls -->
      <div id="bottom-bar">
        <!-- Navigation Row -->
        <div class="nav-row">
          <button id="btn-sessions" class="nav-btn">
            <span class="nav-icon">üìÅ</span>
            <span class="nav-label">Sessions</span>
          </button>
          <button id="btn-map" class="nav-btn">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span class="nav-label">Map</span>
          </button>
          <button id="btn-settings" class="nav-btn">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">Settings</span>
          </button>
          <button id="btn-debug" class="nav-btn">
            <span class="nav-icon">üêõ</span>
            <span class="nav-label">Debug</span>
          </button>
        </div>
        
        <!-- Recording Controls -->
        <div class="controls-row">
          <!-- Idle State -->
          <div id="controls-idle" class="control-set">
            <button id="btn-start" class="btn btn-large btn-success">
              <span class="btn-icon">‚ñ∂</span>
              <span class="btn-label">New</span>
            </button>
          </div>
          
          <!-- Recording State -->
          <div id="controls-recording" class="control-set" style="display: none;">
            <button id="btn-pause" class="btn btn-large btn-warning">
              <span class="btn-icon">‚è∏</span>
              <span class="btn-label">Pause</span>
            </button>
            <button id="btn-stop" class="btn btn-large btn-danger">
              <span class="btn-icon">‚èπ</span>
              <span class="btn-label">Stop</span>
            </button>
          </div>
          
          <!-- Paused State -->
          <div id="controls-paused" class="control-set" style="display: none;">
            <button id="btn-resume" class="btn btn-large btn-success">
              <span class="btn-icon">‚ñ∂</span>
              <span class="btn-label">Resume</span>
            </button>
            <button id="btn-stop-paused" class="btn btn-large btn-danger">
              <span class="btn-icon">‚èπ</span>
              <span class="btn-label">Stop</span>
            </button>
          </div>
          
          <!-- Stopped State -->
          <div id="controls-stopped" class="control-set" style="display: none;">
            <button id="btn-new-session" class="btn btn-large btn-secondary">
              <span class="btn-icon">+</span>
              <span class="btn-label">New</span>
            </button>
            <button id="btn-publish" class="btn btn-large btn-primary">
              <span class="btn-icon">‚òÅÔ∏è</span>
              <span class="btn-label">Publish</span>
            </button>
            <button id="btn-export" class="btn btn-large btn-secondary">
              <span class="btn-icon">üíæ</span>
              <span class="btn-label">Export</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Map View -->
    <div id="map-view" class="view">
      <div id="map-header">
        <button id="map-back" class="back-btn">‚Üê Back</button>
        <h2>Coverage Map</h2>
        <div class="spacer"></div>
      </div>
      <div id="coverage-map"></div>
      <div id="map-legend">
        <div class="legend-item">
          <span class="legend-color published"></span>
          <span>Published</span>
        </div>
        <div class="legend-item">
          <span class="legend-color pending"></span>
          <span>Pending</span>
        </div>
        <div class="legend-item">
          <span class="legend-color current"></span>
          <span>Current</span>
        </div>
      </div>
      <button id="btn-record-here" class="fab">
        <span>üì∑ Record Here</span>
      </button>
    </div>
    
    <!-- Sessions Panel -->
    <div id="sessions-panel" class="panel">
      <div class="panel-header">
        <button id="sessions-back" class="back-btn">‚Üê Back</button>
        <h2>Sessions</h2>
        <button id="btn-clear-all" class="text-btn danger">Clear All</button>
      </div>
      <div id="sessions-list">
        <div id="no-sessions" class="empty-state">
          <span class="empty-icon">üìÅ</span>
          <p>No sessions yet</p>
          <p class="small">Start recording to create a session</p>
        </div>
      </div>
    </div>
    
    <!-- Settings Panel -->
    <div id="settings-panel" class="panel">
      <div class="panel-header">
        <button id="settings-back" class="back-btn">‚Üê Back</button>
        <h2>Settings</h2>
        <div class="spacer"></div>
      </div>
      <div class="settings-content">
        
        <div class="settings-section">
          <h3>üîë API Tokens</h3>
          
          <div class="setting-item vertical">
            <label for="github-token">GitHub Personal Access Token</label>
            <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx" class="setting-input-full">
            <span class="setting-hint">Required for publishing. Needs 'repo' scope.</span>
          </div>
          
          <div class="setting-item vertical">
            <label for="github-repo">GitHub Repository</label>
            <input type="text" id="github-repo" placeholder="username/repo-name" class="setting-input-full">
            <span class="setting-hint">Where to publish survey data</span>
          </div>
          
          <div class="setting-item vertical">
            <label for="github-branch">Branch</label>
            <input type="text" id="github-branch" placeholder="main" value="main" class="setting-input-full">
          </div>
          
          <div class="setting-item vertical">
            <label for="contributor">Contributor Name</label>
            <input type="text" id="contributor" placeholder="Your name or username" class="setting-input-full">
            <span class="setting-hint">Shown in coverage map</span>
          </div>
          
          <div class="setting-item vertical">
            <label for="mapbox-token">Mapbox Access Token</label>
            <input type="password" id="mapbox-token" placeholder="pk.xxxxxxxx" class="setting-input-full">
            <span class="setting-hint">Required for map visualization</span>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>üì∑ Capture Settings</h3>
          
          <div class="setting-item">
            <label for="capture-interval">Capture Interval</label>
            <div class="setting-input">
              <input type="number" id="capture-interval" value="2000" min="500" max="10000" step="500">
              <span class="input-suffix">ms</span>
            </div>
          </div>
          
          <div class="setting-item">
            <label for="image-quality">Image Quality</label>
            <div class="setting-input">
              <input type="range" id="image-quality" min="0.3" max="1.0" step="0.1" value="0.7">
              <span class="range-value">0.7</span>
            </div>
          </div>
          
          <div class="setting-item">
            <label for="image-resolution">Max Width</label>
            <div class="setting-input">
              <select id="image-resolution">
                <option value="640">640px (Small)</option>
                <option value="1280" selected>1280px (Medium)</option>
                <option value="1920">1920px (Large)</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>üíæ Storage</h3>
          
          <div class="setting-item">
            <label for="github-limit">GitHub Limit</label>
            <div class="setting-input">
              <input type="number" id="github-limit" value="1000" min="100" max="5000" step="100">
              <span class="input-suffix">MB</span>
            </div>
          </div>
          
          <div class="storage-info">
            <div class="info-row">
              <span>Local Storage Used:</span>
              <span id="local-storage-used">-- MB</span>
            </div>
            <div class="info-row">
              <span>Available:</span>
              <span id="local-storage-available">-- MB</span>
            </div>
          </div>
        </div>
        
        <button id="btn-save-settings" class="btn btn-primary btn-full">Save Settings</button>
      </div>
    </div>
    
    <!-- Session Name Modal -->
    <div id="session-name-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <h3>New Session</h3>
        <input type="text" id="session-name" placeholder="Session name (optional)">
        <div class="modal-actions">
          <button id="btn-cancel-session" class="btn btn-secondary">Cancel</button>
          <button id="btn-create-session" class="btn btn-primary">Start Recording</button>
        </div>
      </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <h3>Delete Session?</h3>
        <p>This will permanently delete all captures in this session.</p>
        <div class="modal-actions">
          <button id="btn-cancel-delete" class="btn btn-secondary">Cancel</button>
          <button id="btn-confirm-delete" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
    
    <!-- Recovery Modal -->
    <div id="recovery-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <h3>üîÑ Session Recovery</h3>
        <p>Found an interrupted session:</p>
        <div class="recovery-info">
          <p><strong id="recovery-session-name"></strong></p>
          <p><span id="recovery-capture-count">0</span> captures recorded</p>
        </div>
        <div id="recovery-gap-warning" class="warning-box" style="display: none;">
          <span class="warning-icon">‚ö†Ô∏è</span>
          <span>~<span id="recovery-missed-frames">0</span> frames may have been missed during interruption</span>
        </div>
        <div class="modal-actions">
          <button id="btn-discard-recovery" class="btn btn-secondary">Discard</button>
          <button id="btn-resume-recovery" class="btn btn-success">Resume Session</button>
        </div>
      </div>
    </div>
    
    <!-- Publish Progress Modal -->
    <div id="publish-modal" class="modal" style="display: none;">
      <div class="modal-content modal-large">
        <h3>‚òÅÔ∏è Publishing to GitHub</h3>
        
        <div class="publish-progress">
          <div class="progress-bar">
            <div id="publish-progress-fill" class="progress-fill"></div>
          </div>
          <div class="progress-stats">
            <span><span id="publish-completed">0</span> / <span id="publish-total">0</span></span>
            <span id="publish-percent">0%</span>
          </div>
        </div>
        
        <p id="publish-status" class="publish-status">Preparing...</p>
        <p id="publish-time" class="publish-time"></p>
        
        <div id="publish-errors" class="warning-box" style="display: none;">
          <span class="warning-icon">‚ö†Ô∏è</span>
          <span><span id="publish-error-count">0</span> uploads failed (will retry)</span>
        </div>
        
        <div class="modal-actions">
          <button id="btn-pause-publish" class="btn btn-warning">
            <span class="btn-label">Pause</span>
          </button>
          <button id="btn-cancel-publish" class="btn btn-danger">
            <span class="btn-label">Cancel</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Debug Console -->
    <div id="debug-panel" class="panel">
      <div class="panel-header">
        <button id="debug-back" class="back-btn">‚Üê Back</button>
        <h2>Debug Console</h2>
        <button id="btn-clear-logs" class="text-btn">Clear</button>
      </div>
      <div id="debug-controls">
        <label class="toggle-label">
          <input type="checkbox" id="debug-enabled" checked>
          <span>Enable Logging</span>
        </label>
        <label class="toggle-label">
          <input type="checkbox" id="debug-network">
          <span>Network</span>
        </label>
        <label class="toggle-label">
          <input type="checkbox" id="debug-verbose">
          <span>Verbose</span>
        </label>
        <button id="btn-copy-logs" class="btn btn-secondary btn-small">Copy All</button>
        <button id="btn-download-logs" class="btn btn-secondary btn-small">Download</button>
      </div>
      <div id="debug-stats">
        <span id="debug-log-count">0 logs</span>
        <span id="debug-error-count">0 errors</span>
        <span id="debug-warn-count">0 warnings</span>
      </div>
      <div id="debug-log-container">
        <div id="debug-log"></div>
      </div>
    </div>
  </div>
  
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="debug.js?v=1.0.1"></script>
  <script src="storage.js?v=1.0.1"></script>
  <script src="map.js?v=1.0.1"></script>
  <script src="publisher.js?v=1.0.1"></script>
  <script src="app.js?v=1.0.1"></script>
</body>
</html>
